<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Saraswati – Media Hub (Webcam gestures v2)</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    :root{--bg:#0b0b0c;--panel:#141419;--muted:#9aa0a6;--text:#fff;--line:#222;--accent:#8ab4f8}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
    header{grid-column:1/3;display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--line);background:#0e0e12;position:sticky;top:0;z-index:10}
    header .title{font-weight:700}
    header .sp{flex:1}
    header .search{min-width:220px;max-width:420px;width:100%;background:#0d0d11;border:1px solid #2a2a2f;border-radius:999px;color:#eee;padding:8px 12px;outline:none}
    .sidebar{border-right:1px solid var(--line);overflow:auto;background:var(--panel);z-index:5;position:relative}
    .list{padding:8px;display:flex;flex-direction:column;gap:8px}
    .item{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid #1e1e24;background:#101014;border-radius:12px;cursor:pointer}
    .item.active{outline:2px solid var(--accent);border-color:#2a2a40}
    .item .badge{min-width:54px;height:32px;border-radius:8px;background:#050508;display:flex;align-items:center;justify-content:center;color:#bbb;font-weight:700;font-size:11px;border:1px solid #1f1f28}
    .item .meta{min-width:0}
    .item .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .type{color:#aaa;font-size:11px}
    .main{position:relative;overflow:hidden;background:#000;z-index:1}
    .stage{position:relative;width:100%;height:100%;}
    a-scene.embedded{width:100% !important;height:100% !important;position:relative !important;display:block !important}
    canvas.a-canvas{position:absolute !important;inset:0 !important}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:#000;z-index:4}
    .overlay iframe{width:100%;height:100%;border:0;background:#000}
    .overlay .audioBox{display:flex;flex-direction:column;align-items:center;gap:16px}
    .overlay .audioBox h2{margin:0;font-size:16px}

    .controls{position:absolute;left:12px;bottom:12px;display:flex;gap:8px;z-index:6}
    .btn{height:36px;min-width:44px;padding:0 12px;border-radius:10px;border:1px solid #2a2a2f;background:#18181f;color:#fff;cursor:pointer}

    .toast{position:absolute;left:12px;top:12px;background:#111a;color:#eee;border:1px solid #333;padding:6px 10px;border-radius:10px;z-index:6}
    .err{position:absolute;left:12px;bottom:12px;background:#300;border:1px solid #a00;color:#fff;padding:8px 10px;border-radius:8px;display:none;z-index:6;white-space:pre-wrap;max-width:min(70vw, 560px)}
    .vrbtn{position:absolute;right:12px;bottom:12px;z-index:6}

    /* Camera + gesture status */
    .camHud{position:absolute;right:12px;top:12px;display:flex;flex-direction:column;gap:6px;z-index:8;align-items:flex-end}
    .badge{background:#111a;color:#eee;border:1px solid #333;padding:4px 8px;border-radius:8px;font:11px system-ui}
    .camWrap{position:relative;width:220px;height:150px;border-radius:10px;overflow:hidden;border:1px solid #222;background:#000}
    .camWrap video,.camWrap canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .camBtns{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Saraswati – Media Hub</div>
      <div class="sp"></div>
      <input id="q" class="search" type="search" placeholder="Search playlist…"/>
    </header>

    <aside class="sidebar">
      <div id="list" class="list"></div>
    </aside>

    <main class="main">
      <div id="toast" class="toast" style="display:none"></div>
      <div id="err" class="err"></div>

      <!-- Right column content -->
      <div id="stage" class="stage">
        <a-scene id="scene" embedded
                 renderer="colorManagement: true; physicallyCorrectLights: true"
                 background="color: #0b0b0c"
                 webxr="optionalFeatures: hand-tracking, local-floor, bounded-floor"
                 xr-mode-ui="enabled: true">
          <a-entity light="type: hemisphere; intensity: 0.6; color: #fff0e0; groundColor: #0a0a12" position="0 10 0"></a-entity>
          <a-entity id="dirLight" light="type: directional; intensity: 1.0; castShadow: true" position="4 10 6"></a-entity>
          <a-plane position="0 0 0" rotation="-90 0 0" width="200" height="200" color="#2a2a30" shadow="receive: true"></a-plane>
          <a-entity id="idol" position="0 0 0" shadow="cast: true; receive: true"></a-entity>
          <a-entity id="rig" position="0 1.6 6">
            <a-entity id="camera" camera look-controls wasd-controls></a-entity>
          </a-entity>
          <a-entity id="leftCtl" oculus-touch-controls="hand: left"></a-entity>
          <a-entity id="rightCtl" oculus-touch-controls="hand: right"></a-entity>
          <a-entity id="leftHand" hand-tracking-controls="hand: left"></a-entity>
          <a-entity id="rightHand" hand-tracking-controls="hand: right"></a-entity>
        </a-scene>

        <button id="enterVR" class="btn vrbtn">Enter VR</button>
      </div>

      <!-- Overlay for audio/YouTube -->
      <div id="overlay" class="overlay"></div>

      <!-- Controls -->
      <div class="controls">
        <button id="prev" class="btn">◀︎ Prev</button>
        <button id="next" class="btn">Next ▶︎</button>
      </div>

      <!-- Camera HUD (webcam + status + controls) -->
      <div class="camHud">
        <div class="camWrap">
          <video id="cam" autoplay playsinline muted></video>
          <canvas id="camCanvas"></canvas>
        </div>
        <div class="camBtns">
          <button id="startCam" class="btn">Start Camera</button>
          <button id="stopCam" class="btn">Stop</button>
        </div>
        <div class="badge" id="camStatus">Camera: off</div>
        <div class="badge" id="gestStatus">Gesture: none</div>
        <div class="badge" id="debugStatus">Debug: -</div>
      </div>
    </main>
  </div>

  <script>
    // --- Utilities / UI helpers ---
    const $ = sel => document.querySelector(sel);
    const toast = $('#toast');
    const err = $('#err');
    function showToast(t, ms=1200){ toast.textContent = t; toast.style.display = 'block'; clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.style.display='none', ms); }
    function showErr(t){ err.style.display='block'; err.textContent = t; }

    // --- A-Frame idol setup ---
    const params = new URLSearchParams(location.search);
    const modelURL = params.get('model') || '/assets/3d/saraswathi.glb';
    const idol = document.getElementById('idol');
    idol.setAttribute('gltf-model', modelURL);
    idol.addEventListener('model-error', (e) => {
      const msg = (e && e.detail && e.detail.src) ? ('Failed to load ' + e.detail.src) : 'Model load failed';
      showErr(msg + '\nCheck the path exists and is reachable.');
    });
    idol.addEventListener('model-loaded', () => {
      try {
        const obj = idol.getObject3D('mesh');
        if (obj) {
          obj.traverse(n => { if (n.isMesh){ n.castShadow = n.receiveShadow = true; }});
          const box = new THREE.Box3().setFromObject(obj);
          const size = new THREE.Vector3(); box.getSize(size);
          const center = new THREE.Vector3(); box.getCenter(center);
          const targetH = 2.2;
          const s = size.y > 1e-4 ? (targetH / size.y) : 1.0;
          obj.scale.setScalar(s);
          const box2 = new THREE.Box3().setFromObject(obj);
          const min2 = box2.min.clone();
          const cen2 = box2.getCenter(new THREE.Vector3());
          const lift = -min2.y + 0.5;
          obj.position.set(-cen2.x, lift, -cen2.z);
        }
      } catch (e) { showErr(String(e && e.message || e)); }
    });
  </script>

  <!-- Playlist / Player / Gestures -->
  <script>
    const listEl = document.getElementById('list');
    const overlay = document.getElementById('overlay');
    const input = document.getElementById('q');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const enterVRBtn = document.getElementById('enterVR');
    const scn = document.getElementById('scene');

    function typeBadge(t){ if (t === 'webxr') return 'VR'; if (t === 'audio') return 'Audio'; if (t === 'youtube') return 'Video'; if (t === 'youtube_playlist') return 'Playlist'; return t || 'Item'; }
    function itemHTML(item, active){ return '<div class="item'+(active?' active':'')+'" data-id="'+item.id+'">' + '<div class="badge">'+ typeBadge(item.type) +'</div>' + '<div class="meta"><div class="title">'+ item.title +'</div><div class="type">'+ (item.type||'') +'</div></div>' + '</div>'; }

    const DEFAULT_PLAYLIST = [
      { id:"vr-temple", type:"webxr", title:"VR: Saraswati Temple (WebXR)", url:"#internal" },
      { id:"Saraswati Namostute", type:"audio", title:"Saraswati Namostute", url:"/assets/audio/Saraswati Namostute.mp3" },
      { id:"Saraswati Dwadash Naam Stotram", type:"audio", title:"Saraswati Dwadash Naam Stotram", url:"/assets/audio/Saraswati Dwadash Naam Stotram.mp3" },
      { id:"Saraswati Chalisa", type:"audio", title:"Saraswati Chalisa", url:"/assets/audio/Saraswati Chalisa.mp3" },
      { id:"Sarasvati Vandana", type:"audio", title:"Sarasvati Vandana", url:"/assets/audio/Sarasvati Vandana.mp3" },
      { id:"Sarasvati Mahabhadra", type:"audio", title:"Sarasvati Mahabhadra", url:"/assets/audio/Sarasvati Mahabhadra.mp3" },
      { id:"Sri Saraswathi Ashtakam", type:"audio", title:"Sri Saraswathi Ashtakam", url:"/assets/audio/Sri Saraswathi Ashtakam.mp3" },
      { id:"yt-stories", type:"youtube_playlist", title:"Saraswati Stories (YouTube Playlist)", url:"https://www.youtube.com/playlist?list=PLY7o2LjD14VqHRYMmYtQ1ffw5zNPHYwXf" }
    ];
  </script>
  <script src="/playlist.js"></script>
  <script>
    const playlist = (window.SARASWATI_PLAYLIST && window.SARASWATI_PLAYLIST.length) ? window.SARASWATI_PLAYLIST : DEFAULT_PLAYLIST;
    let filtered = playlist.slice();
    let idx = 0;
    let currentAudio = null;

    function renderList(){ listEl.innerHTML = filtered.map((it, i)=> itemHTML(it, i===idx)).join(''); }
    function setActive(i){ idx = Math.max(0, Math.min(filtered.length-1, i)); renderList(); play(filtered[idx]); }
    function ytEmbed(url){
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtube.com') && u.searchParams.get('list')) return 'https://www.youtube.com/embed/videoseries?list=' + u.searchParams.get('list') + '&rel=0&modestbranding=1&playsinline=1';
        let id = u.searchParams.get('v'); if (!id && u.hostname.includes('youtu.be')) id = u.pathname.slice(1);
        return 'https://www.youtube.com/embed/' + id + '?rel=0&modestbranding=1&playsinline=1';
      }catch{ return url; }
    }
    function clearOverlay(){ overlay.style.display = 'none'; overlay.innerHTML = ''; if (currentAudio){ try{ currentAudio.pause(); }catch{} } currentAudio = null; }
    function showOverlayAudio(title, url){
      overlay.innerHTML = ''; const box = document.createElement('div'); box.className = 'audioBox';
      const h2 = document.createElement('h2'); h2.textContent = title; const au = document.createElement('audio'); au.controls = true; au.autoplay = true; au.src = url; au.style.width = 'min(640px, 90vw)';
      box.appendChild(h2); box.appendChild(au); overlay.appendChild(box); overlay.style.display = 'flex'; currentAudio = au;
    }
    function showOverlayIframe(url){
      overlay.innerHTML = ''; const iframe = document.createElement('iframe');
      iframe.allow = 'autoplay; fullscreen; xr-spatial-tracking; camera; microphone; accelerometer; gyroscope'; iframe.allowFullscreen = true; iframe.referrerPolicy = 'no-referrer'; iframe.src = url;
      overlay.appendChild(iframe); overlay.style.display = 'flex';
    }
    function showScene(){ clearOverlay(); showToast('VR scene'); }
    function play(item){
      Array.from(document.querySelectorAll('.item')).forEach((el,i)=> el.classList.toggle('active', i===idx));
      if (item.type === 'audio'){ showOverlayAudio(item.title, item.url); showToast('Playing: ' + item.title); return; }
      if (item.type === 'youtube' || item.type === 'youtube_playlist'){ showOverlayIframe(ytEmbed(item.url)); showToast('Loading: ' + item.title); return; }
      showScene();
    }

    // Clicks
    listEl.addEventListener('click', (e)=>{ const card = e.target.closest('.item'); if (!card) return; const i = Array.from(listEl.children).indexOf(card); setActive(i); });
    // Prev / Next buttons
    function prev(){ setActive((idx - 1 + filtered.length) % filtered.length); }
    function next(){ setActive((idx + 1) % filtered.length); }
    prevBtn.onclick = prev; nextBtn.onclick = next;
    // Search
    input.addEventListener('input', ()=>{ const q = input.value.trim().toLowerCase(); filtered = !q ? playlist.slice() : playlist.filter(it => it.title.toLowerCase().includes(q)); idx = 0; renderList(); });
    // Enter VR
    enterVRBtn.addEventListener('click', ()=>{ if (scn && scn.enterVR) scn.enterVR(); });

    // Touch/mouse/keys fallback
    let sx=null, sy=null, dragging=false;
    function start(x,y){ sx=x; sy=y; dragging=true; }
    function end(x,y){ if (!dragging) return; dragging=false; const dx = x - sx, dy = y - sy; if (Math.abs(dx) > Math.max(60, Math.abs(dy)*1.6)){ if (dx < 0) next(); else prev(); } }
    document.body.addEventListener('touchstart', e=> start(e.touches[0].clientX, e.touches[0].clientY), {passive:true});
    document.body.addEventListener('touchend', e=> end(e.changedTouches[0].clientX, e.changedTouches[0].clientY));
    document.body.addEventListener('mousedown', e=> start(e.clientX, e.clientY));
    document.body.addEventListener('mouseup', e=> end(e.clientX, e.clientY));
    window.addEventListener('keydown', e=>{ if (e.key === 'ArrowRight') next(); else if (e.key === 'ArrowLeft') prev(); });

    // --- Webcam gestures (improved) ---
    const camStatus = document.getElementById('camStatus');
    const gestStatus = document.getElementById('gestStatus');
    const debugStatus = document.getElementById('debugStatus');
    const startBtn = document.getElementById('startCam');
    const stopBtn = document.getElementById('stopCam');
    const video = document.getElementById('cam');
    const canvas = document.getElementById('camCanvas');
    const ctx = canvas.getContext('2d');
    let camera = null, hands = null, camRunning = false;

    function setCamStatus(s){ camStatus.textContent = 'Camera: ' + s; }
    function setGestStatus(s){ gestStatus.textContent = 'Gesture: ' + s; }
    function setDebug(s){ debugStatus.textContent = 'Debug: ' + s; }

    function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y, dz=(a.z||0)-(b.z||0); return Math.hypot(dx,dy,dz); }

    function extendedCount(lm){
      // indices of tips and MCPs: index(8,5), middle(12,9), ring(16,13), pinky(20,17)
      const wrist = lm[0];
      const pairs = [[8,5],[12,9],[16,13],[20,17]];
      const base = dist(lm[0], lm[9]) || 1; // hand scale ~ wrist->middle_mcp
      let count = 0;
      for (const [tip,mcp] of pairs){
        const dTip = dist(lm[tip], wrist);
        const dMcp = dist(lm[mcp], wrist);
        if (dTip > dMcp + 0.10*base) count++; // margin improves stability
      }
      return count; // 0..4
    }

    // Hysteresis: require 3 consecutive frames of the same class
    let openFrames = 0, fistFrames = 0;
    const cooldown = {next:0, prev:0}, GAP=650;

    function classifyAndAct(allLm){
      if (!allLm || !allLm.length){ setGestStatus('none'); setDebug('-'); openFrames=0; fistFrames=0; return; }
      // Choose the hand with more extension
      let best = {ext:-1, idx:0};
      allLm.forEach((lm,i)=>{ const ext = extendedCount(lm); if (ext>best.ext){ best={ext, idx:i}; }});
      const ext = best.ext;
      // Fallback: openness average as tie-breaker (optional)
      setDebug('extended=' + ext);

      if (ext >= 3){ openFrames++; fistFrames=0; setGestStatus('open ('+ext+'/4)'); }
      else if (ext <= 1){ fistFrames++; openFrames=0; setGestStatus('fist ('+ext+'/4)'); }
      else { setGestStatus('neutral ('+ext+'/4)'); openFrames=0; fistFrames=0; }

      const now = performance.now();
      if (openFrames >= 3 && (now - cooldown.next > GAP)){ cooldown.next = now; openFrames=0; next(); showToast('▶︎ Next (open palm)'); }
      if (fistFrames >= 3 && (now - cooldown.prev > GAP)){ cooldown.prev = now; fistFrames=0; prev(); showToast('◀︎ Prev (fist)'); }
    }

    function onResults(results){
      const w = canvas.width = video.videoWidth || 640;
      const h = canvas.height = video.videoHeight || 480;
      ctx.save();
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(results.image, 0, 0, w, h);
      if (results.multiHandLandmarks && results.multiHandLandmarks.length){
        for (const landmarks of results.multiHandLandmarks){
          drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#6cf', lineWidth: 2});
          drawLandmarks(ctx, landmarks, {color: '#fff', lineWidth: 1, radius: 1.4});
        }
        classifyAndAct(results.multiHandLandmarks);
      }else{
        setGestStatus('none');
        setDebug('-');
        openFrames=0; fistFrames=0;
      }
      ctx.restore();
    }

    async function startCamera(){
      try{
        hands = new Hands({locateFile: (file)=> 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/' + file});
        hands.setOptions({maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.5});
        hands.onResults(onResults);

        camera = new Camera(video, {
          onFrame: async () => { if (hands) await hands.send({image: video}); },
          width: 640, height: 480
        });
        await camera.start();
        camRunning = true;
        setCamStatus('on');
        setGestStatus('none');
      }catch(e){
        setCamStatus('error');
        showErr('Camera error: ' + (e && e.message ? e.message : e));
      }
    }
    function stopCamera(){
      try{ if (camera && camera.stop) camera.stop(); }catch{}
      camRunning = false;
      setCamStatus('off');
    }
    document.getElementById('startCam').addEventListener('click', startCamera);
    document.getElementById('stopCam').addEventListener('click', stopCamera);
    (async ()=>{ try{ await startCamera(); }catch{} })();

    // Boot the UI
    renderList(); play(filtered[idx]);
  </script>
</body>
</html>
